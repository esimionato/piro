((function(){var a;a=typeof global!="undefined"&&global!==null?global:window,a.PivotalRocketBackground={account:null,pivotal_api_lib:null,init_popup:function(){var a,b,c,d,e;b=chrome.extension.getViews({type:"popup"});if(b.length>0){e=[];for(c=0,d=b.length;c<d;c++)a=b[c],PivotalRocketStorage.get_accounts().length>0?(a.$("#loginPage").hide(),PivotalRocketBackground.account=PivotalRocketStorage.get_accounts()[0],PivotalRocketBackground.initial_sync(),e.push(a.$("#mainPage").show())):(a.$("#mainPage").hide(),e.push(a.$("#loginPage").show()));return e}},init_login:function(){var a,b,c,d,e,f=this;b=chrome.extension.getViews({type:"popup"});if(b.length>0){e=[];for(c=0,d=b.length;c<d;c++)a=b[c],e.push(a.$("#login_button").click(function(b){var c,d,e;e=a.$("#login_username").val(),c=a.$("#login_password").val();if(e!=null&&c!=null)return d=new PivotalAuthLib({username:e,password:c,success:function(a,b,c){var d;return d=XML2JSON.parse(a,!0),d.person!=null&&(d=d.person),PivotalRocketBackground.account=PivotalRocketBackground.save_account(d),PivotalRocketBackground.initial_sync()},error:function(a,b,c){}})}));return e}},initial_sync:function(){var a=this;return PivotalRocketBackground.pivotal_api_lib=new PivotalApiLib(PivotalRocketBackground.account),PivotalRocketBackground.pivotal_api_lib.get_projects({success:function(a,b,c){var d,e,f,g,h,i;d=XML2JSON.parse(a,!0),f=[],d.projects!=null&&d.projects.project!=null&&(f=d.projects.project),f.constructor!==Array&&(f=[f]),PivotalRocketStorage.set_projects(PivotalRocketBackground.account,f),i=[];for(g=0,h=f.length;g<h;g++)e=f[g],i.push(PivotalRocketBackground.pivotal_api_lib.get_stories_for_project({project:e,success:function(a,b,c){var d,e;return e=[],d=XML2JSON.parse(a,!0),d.stories!=null&&d.stories.story!=null&&(e=d.stories.story),e.constructor!==Array&&(e=[e]),console.debug(e)},error:function(a,b,c){}}));return i},error:function(a,b,c){}})},save_account:function(a){var b,c,d,e;if(a.email!=null)return b=PivotalRocketStorage.get_accounts(),c=!1,d=function(){var d,f,g;g=[];for(d=0,f=b.length;d<f;d++)e=b[d],e.email!=null?e.email===a.email?(c=!0,g.push(a)):g.push(e):g.push(void 0);return g}(),c===!1&&d.push(a),PivotalRocketStorage.set_accounts(d),a}}})).call(this)

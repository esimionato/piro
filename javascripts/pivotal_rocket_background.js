((function(){var a;a=typeof global!="undefined"&&global!==null?global:window,a.PivotalRocketBackground={account:null,pivotal_api_lib:null,popup:null,is_loading:!1,tmp_counter:0,init:function(){if(PivotalRocketStorage.get_accounts().length>0)return PivotalRocketBackground.account=PivotalRocketStorage.get_accounts()[0],PivotalRocketBackground.initial_sync()},load_popup_view:function(){return chrome.extension.getViews({type:"popup"})[0]},init_popup:function(){PivotalRocketBackground.popup==null&&(PivotalRocketBackground.popup=PivotalRocketBackground.load_popup_view());if(PivotalRocketBackground.popup!=null)return PivotalRocketBackground.init_spinner(PivotalRocketBackground.is_loading),PivotalRocketBackground.init_bindings(),PivotalRocketStorage.get_accounts().length>0?(PivotalRocketBackground.init_list_stories(),PivotalRocketBackground.popup.$("#loginPage").hide(),PivotalRocketBackground.popup.$("#mainPage").show()):(PivotalRocketBackground.popup.$("#mainPage").hide(),PivotalRocketBackground.popup.$("#loginPage").show())},init_bindings:function(){var a=this;return PivotalRocketBackground.popup.$("#storiesTabs").tabs(),PivotalRocketBackground.popup.$("#login_button").click(function(a){var b,c;return c=PivotalRocketBackground.popup.$("#login_username").val(),b=PivotalRocketBackground.popup.$("#login_password").val(),PivotalRocketBackground.login_by_user(c,b)}),PivotalRocketBackground.popup.$("#updateStories").click(function(a){return PivotalRocketBackground.is_loading=!0,PivotalRocketBackground.init_spinner(PivotalRocketBackground.is_loading),PivotalRocketBackground.initial_sync()})},init_spinner:function(a){var b,c,d;a==null&&(a=!1),d=PivotalRocketBackground.popup.$("#spinner_template").html();if(d.length>0)return b=Hogan.compile(d),c={update_msg:chrome.i18n.getMessage("update_stories_link")},a&&(c.is_loading={loading_msg:chrome.i18n.getMessage("loading_msg")}),PivotalRocketBackground.popup.$("#loaderSpinner").html(b.render(c))},init_list_stories:function(){var a,b,c,d,e,f,g,h,i,j;h=PivotalRocketBackground.popup.$("#project_cell").html();if(h.length>0){a=Hogan.compile(h),g={current:[],done:[],icebox:[]},f={current:0,done:0,icebox:0},d=PivotalRocketStorage.get_projects(PivotalRocketBackground.account);for(i=0,j=d.length;i<j;i++)c=d[i],e=PivotalRocketStorage.get_status_stories(c),e!=null&&(e.current!=null&&e.current.length>0&&(c.stories=e.current,f.current+=e.current.length,g.current.push(a.render(c))),e.done!=null&&e.done.length>0&&(c.stories=e.done,f.done+=e.done.length,g.done.push(a.render(c))),e.icebox!=null&&e.icebox.length>0&&(c.stories=e.icebox,f.icebox+=e.icebox.length,g.icebox.push(a.render(c))));return b="<li class='empty'>"+chrome.i18n.getMessage("no_stories_msg")+"</li>",PivotalRocketBackground.popup.$("#currentTabLabel").text(""+chrome.i18n.getMessage("current_stories_tab")+" ("+f.current.toString()+")"),f.current>0?PivotalRocketBackground.popup.$("#currentStoriesList").html(g.current.join("")):PivotalRocketBackground.popup.$("#currentStoriesList").html(b),PivotalRocketBackground.popup.$("#doneTabLabel").text(""+chrome.i18n.getMessage("done_stories_tab")+" ("+f.done.toString()+")"),f.done>0?PivotalRocketBackground.popup.$("#doneStoriesList").html(g.done.join("")):PivotalRocketBackground.popup.$("#doneStoriesList").html(b),PivotalRocketBackground.popup.$("#iceboxTabLabel").text(""+chrome.i18n.getMessage("icebox_stories_tab")+" ("+f.icebox.toString()+")"),f.icebox>0?PivotalRocketBackground.popup.$("#iceboxStoriesList").html(g.icebox.join("")):PivotalRocketBackground.popup.$("#iceboxStoriesList").html(b)}},initial_sync:function(){return PivotalRocketBackground.pivotal_api_lib=new PivotalApiLib(PivotalRocketBackground.account),PivotalRocketBackground.pivotal_api_lib.get_projects({success:function(a,b,c){var d,e,f,g,h,i;d=XML2JSON.parse(a,!0),f=[],d.projects!=null&&d.projects.project!=null&&(f=d.projects.project),f.constructor!==Array&&(f=[f]),PivotalRocketStorage.set_projects(PivotalRocketBackground.account,f),PivotalRocketBackground.tmp_counter=f.length,i=[];for(g=0,h=f.length;g<h;g++)e=f[g],i.push(PivotalRocketBackground.pivotal_api_lib.get_stories_for_project({project:e,complete:function(a,b){PivotalRocketBackground.tmp_counter-=1;if(PivotalRocketBackground.tmp_counter<=0)return PivotalRocketBackground.is_loading=!1,PivotalRocketBackground.init_spinner(PivotalRocketBackground.is_loading)},success:function(a,b,c){var d,e;e=[],d=XML2JSON.parse(a,!0),d.stories!=null&&d.stories.story!=null&&(e=d.stories.story),e.constructor!==Array&&(e=[e]);if(e.length>0)return PivotalRocketStorage.set_stories_by_project_id(e[0].project_id,e)},error:function(a,b,c){}}));return i},error:function(a,b,c){}})},save_account:function(a){var b,c,d,e;if(a.email!=null)return b=PivotalRocketStorage.get_accounts(),c=!1,d=function(){var d,f,g;g=[];for(d=0,f=b.length;d<f;d++)e=b[d],e.email!=null?e.email===a.email?(c=!0,g.push(a)):g.push(e):g.push(void 0);return g}(),c===!1&&d.push(a),PivotalRocketStorage.set_accounts(d),a},login_by_user:function(a,b){var c;if(a!=null&&b!=null)return c=new PivotalAuthLib({username:a,password:b,success:function(a,b,c){var d;return d=XML2JSON.parse(a,!0),d.person!=null&&(d=d.person),PivotalRocketBackground.account=PivotalRocketBackground.save_account(d),PivotalRocketBackground.initial_sync()},error:function(a,b,c){}})}},$(function(){return PivotalRocketBackground.init()})})).call(this)
